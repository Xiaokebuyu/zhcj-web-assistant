# WebSocket语音通话问题修复说明

## 问题描述

您遇到的四个错误都与WebSocket连接和语音通话功能相关：

1. `WebSocket错误: {}`
2. `豆包语音错误: "WebSocket连接错误"`
3. `开始语音通话失败: {}`
4. `开始语音通话失败: {}`

## 问题根因

主要问题是**浏览器WebSocket API的安全限制**：

1. **认证问题**：豆包的WebSocket服务需要特定的HTTP headers进行认证（如`X-Api-App-ID`、`X-Api-Access-Key`等）
2. **浏览器限制**：浏览器的WebSocket API不支持自定义headers
3. **CORS策略**：跨域WebSocket连接被浏览器阻止

## 解决方案

我们实现了一个**WebSocket代理服务器**来解决这些问题：

### 1. 创建了自定义服务器 (`server.js`)
- 替代了默认的Next.js开发服务器
- 集成了WebSocket代理功能
- 支持豆包服务的认证headers

### 2. 修改了客户端代码
- **doubaoVoiceClient.ts**: 简化连接逻辑，连接到本地代理
- **voiceCallManager.ts**: 改进错误处理和状态管理
- **audioProcessor.ts**: 增强浏览器兼容性检查
- **FloatingAssistant.tsx**: 提供更友好的错误信息

### 3. 更新了配置
- **package.json**: 添加WebSocket依赖，修改启动脚本
- **API路由**: 修改WebSocket URL指向本地代理

## 架构图

```
客户端浏览器 <--WebSocket--> 本地代理服务器 <--WebSocket(带认证)--> 豆包服务
     ^                           ^                                    ^
   普通WebSocket               支持自定义headers                 需要认证headers
```

## 使用方式

### 启动开发服务器
```bash
cd ai-assistant
npm run dev
```

### 访问应用
打开浏览器访问 `http://localhost:3000`

### 测试语音功能
1. 点击语音通话按钮
2. 授权麦克风权限
3. 等待连接到豆包服务
4. 开始语音对话

## 技术细节

### WebSocket代理服务器特性
- **双向代理**：在客户端和豆包服务之间转发消息
- **认证处理**：自动添加豆包所需的认证headers
- **协议转换**：处理豆包的二进制协议
- **错误处理**：提供详细的错误信息和状态反馈

### 客户端改进
- **更好的错误处理**：提供具体的错误信息和解决建议
- **状态管理**：准确跟踪连接状态和通话状态
- **资源清理**：确保正确释放音频和WebSocket资源
- **浏览器兼容性**：检查并提示浏览器支持情况

## 故障排除

### 如果仍然遇到问题

1. **检查控制台日志**：查看具体的错误信息
2. **确认麦克风权限**：浏览器需要授权访问麦克风
3. **使用HTTPS**：某些浏览器在HTTP下限制WebSocket功能
4. **检查网络连接**：确保能访问豆包服务

### 常见错误信息

- `麦克风权限被拒绝`：在浏览器设置中允许访问麦克风
- `浏览器不支持语音通话功能`：使用Chrome、Firefox或Edge浏览器
- `代理服务器连接失败`：确认开发服务器正常运行

## 部署说明

### 生产环境部署
```bash
npm run build
npm start
```

### 环境变量
可以通过环境变量配置：
- `PORT`: 服务器端口（默认3000）
- `NODE_ENV`: 环境模式

## 注意事项

1. **WebSocket代理服务器**是解决浏览器限制的标准做法
2. **豆包API密钥**已硬编码在代码中，生产环境建议使用环境变量
3. **HTTPS部署**时需要确保WebSocket也使用WSS协议
4. **防火墙设置**可能需要允许WebSocket连接

## 更新日志

- ✅ 修复WebSocket连接错误
- ✅ 改进错误处理和用户提示
- ✅ 添加WebSocket代理服务器
- ✅ 优化音频处理和资源管理
- ✅ 增强浏览器兼容性检查

现在您的语音通话功能应该可以正常工作了！ 