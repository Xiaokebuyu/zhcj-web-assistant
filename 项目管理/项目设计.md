## 🎯 最终技术方案：智能网页无障碍助手

### 一、系统架构概览

```
┌─────────────────────────────────────────────────────────┐
│                     用户浏览器                           │
│  ┌─────────────┐    ┌──────────────────────────────┐   │
│  │  悬浮UI组件  │←──→│    网页内容分析器           │   │
│  └──────┬──────┘    └──────────────────────────────┘   │
│         │ WebSocket                                      │
└─────────┼───────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────┐
│         ↓              后端服务集群                      │
│  ┌──────────────┐    ┌────────────────┐                │
│  │   API网关    │───→│   任务调度器    │                │
│  └──────┬───────┘    └───────┬────────┘                │
│         │                     │                          │
│  ┌──────┴───────┬─────────────┼──────────┬────────────┐ │
│  │ 语音服务模块 │  MCP连接池  │ LLM网关  │ 自动化引擎│ │
│  └──────────────┴─────────────┴──────────┴────────────┘ │
│         │                                                │
│  ┌──────┴───────────────────────────────────────────┐   │
│  │           知识库系统 (向量数据库)                 │   │
│  └──────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────┘
```

### 二、核心模块详解

#### 1. **前端嵌入式SDK**
```typescript
// 使用方式
<script src="https://your-domain/assistant-sdk.js"></script>
<script>
  WebAssistant.init({
    apiKey: 'your-api-key',
    position: 'bottom-right',
    theme: 'auto'
  });
</script>
```

**技术栈**：
- TypeScript + Preact（体积小）
- Socket.io-client（实时通信）
- Web Speech API（语音采集）
- Tailwind CSS（样式）

#### 2. **后端服务架构**

**核心服务**：
```typescript
// 主要服务模块
├── gateway-service/        # API网关（Fastify）
├── core-service/          # 核心业务逻辑
├── mcp-service/           # MCP连接管理
├── automation-service/    # 浏览器自动化
├── voice-service/         # 语音处理
└── knowledge-service/     # 知识库检索
```

**技术选型**：
- **框架**: Fastify + TypeScript
- **通信**: Socket.io + Redis Pub/Sub
- **任务队列**: BullMQ
- **状态管理**: XState
- **向量数据库**: PostgreSQL + pgvector
- **缓存**: Redis
- **浏览器自动化**: Playwright

#### 3. **数据流设计**

```typescript
interface AssistantRequest {
  id: string
  type: 'voice' | 'text' | 'automation'
  content: string
  context: {
    pageUrl: string
    pageTitle: string
    userPreferences: UserPrefs
  }
}

interface TaskFlow {
  // 1. 接收请求
  request: AssistantRequest
  
  // 2. 意图识别
  intent: {
    action: 'search' | 'query' | 'automate' | 'help'
    confidence: number
    parameters: any
  }
  
  // 3. 执行计划
  plan: ExecutionPlan[]
  
  // 4. 执行结果
  result: {
    status: 'success' | 'partial' | 'failed'
    data: any
    followUp?: string
  }
}
```

### 三、功能模块实现

#### 1. **MCP集成**
```typescript
// MCP连接管理器
class MCPManager {
  private connections: Map<string, MCPConnection>
  
  async connectToServer(serverConfig: MCPServerConfig) {
    // 使用 @modelcontextprotocol/sdk
  }
  
  async executeCommand(server: string, command: string, params: any) {
    // 执行MCP命令
  }
}
```

#### 2. **知识库系统**
```typescript
// 双层知识库设计
interface KnowledgeBase {
  // 静态层：预构建的网站功能文档
  static: {
    sites: Map<string, SiteKnowledge>
    search: (query: string) => Promise<Document[]>
  }
  
  // 动态层：实时页面分析
  dynamic: {
    analyzePage: (dom: Document) => PageContext
    extractActions: (context: PageContext) => Action[]
  }
}
```

#### 3. **浏览器自动化**
```typescript
// 自动化任务执行器
class AutomationExecutor {
  async executeTask(task: AutomationTask) {
    const browser = await playwright.chromium.launch()
    const page = await browser.newPage()
    
    // 使用状态机管理执行流程
    const machine = createTaskMachine(task)
    
    // 支持中断和恢复
    machine.onTransition((state) => {
      if (state.value === 'paused') {
        // 保存状态，等待用户输入
        await this.saveSnapshot(task.id, state.context)
      }
    })
  }
}
```

### 四、推荐实现流程（6个阶段）

#### **第一阶段：基础框架（2周）**
1. 搭建monorepo项目结构
2. 实现前端悬浮组件基础UI
3. 建立WebSocket通信
4. 搭建后端基础服务框架

**交付物**：能显示悬浮球并建立前后端连接

#### **第二阶段：语音功能（1周）**
1. 集成Web Speech API
2. 对接火山云/阿里云语音服务
3. 实现语音录制和播放
4. 添加语音识别错误处理

**交付物**：支持语音输入输出的对话

#### **第三阶段：LLM集成（1周）**
1. 实现LLM API网关
2. 添加对话上下文管理
3. 实现Function Call基础框架
4. 添加流式响应支持

**交付物**：能进行智能对话

#### **第四阶段：MCP支持（2周）**
1. 集成MCP SDK
2. 实现DuckDuckGo搜索连接
3. 构建MCP工具注册机制
4. 添加工具调用的UI反馈

**交付物**：能通过MCP调用外部工具

#### **第五阶段：知识库系统（2周）**
1. 搭建向量数据库
2. 实现网页爬虫和解析器
3. 构建知识索引和检索
4. 实现动态页面分析

**交付物**：能基于知识库回答问题

#### **第六阶段：浏览器自动化（3周）**
1. 集成Playwright
2. 实现任务状态机
3. 构建任务中断-恢复机制
4. 添加执行进度实时反馈
5. 实现安全沙箱

**交付物**：完整的自动化执行能力

### 五、项目结构

```
web-assistant/
├── packages/
│   ├── client/              # 前端SDK
│   │   ├── src/
│   │   │   ├── components/  # UI组件
│   │   │   ├── services/    # 服务层
│   │   │   └── utils/       # 工具函数
│   │   └── dist/           # 构建产物
│   │
│   ├── server/             # 后端服务
│   │   ├── gateway/        # API网关
│   │   ├── core/          # 核心服务
│   │   ├── mcp/           # MCP服务
│   │   ├── automation/    # 自动化服务
│   │   └── knowledge/     # 知识库服务
│   │
│   └── shared/            # 共享代码
│       ├── types/         # TypeScript类型
│       └── constants/     # 常量定义
│
├── infrastructure/        # 基础设施
│   ├── docker/           # Docker配置
│   └── k8s/             # Kubernetes配置
│
├── scripts/              # 脚本工具
│   ├── crawler/         # 知识库爬虫
│   └── deploy/          # 部署脚本
│
└── docs/                # 文档
    ├── api/            # API文档
    └── guides/         # 使用指南
```

### 六、关键配置示例

**TypeScript配置**：
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "commonjs",
    "lib": ["ES2022", "DOM"],
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "paths": {
      "@shared/*": ["../shared/*"]
    }
  }
}